# トレーニングフロー リデザイン実装計画書

## 概要

トレーニング開始時の感情円環UIをスライダーベースに変更し、3つのガイドモードに対応する。

### 背景

- 開発チーム（10年以上の瞑想実践者2名）がユーザーサンプルとして日常使用
- ①タイマーのみ / ②環境音 を優先開発
- ③瞑想ガイド（初心者向け）は現行仕様を移管し、後で拡張

---

## 画面遷移フロー

### ①タイマーのみ / ②環境音 の場合

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   ホーム    │ → │  時間選択   │ → │   タイマー  │ → │    After    │ → │    完了     │
│ (スライダー)│    │(30秒/5/10分)│    │   (①②用)   │    │ (スライダー)│    │  (りなわん) │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
     │
     └── からだ/こころ/メモ入力
```

### ③瞑想ガイド の場合

```
┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐    ┌─────────────┐
│   ホーム    │ → │  感情円環   │ → │  時間選択   │ → │    瞑想     │ → │    After    │ → │    完了     │
│ (スライダー)│    │  (タップ)   │    │ (30秒/1分等)│    │  (ガイド)   │    │ (スライダー)│    │  (りなわん) │
└─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘    └─────────────┘
```

---

## データ構造

### 設定値（AsyncStorage）

```typescript
// 新規追加
type GuideMode = 'timer' | 'ambient' | 'guided';
type AmbientSound = 'birds' | 'river' | 'rain' | 'wave' | 'bonfire' | 'singing_bowls';

// ストレージキー
GUIDE_MODE: 'pref_guide_mode'      // デフォルト: 'timer'
AMBIENT_SOUND: 'pref_ambient_sound' // デフォルト: 'birds'
```

### SessionLog（既存フィールド活用）

| フィールド | 用途 | 備考 |
|-----------|------|------|
| `beforeValence` | Before からだ (-1〜+1) | 既存流用 |
| `beforeArousal` | Before こころ (-1〜+1) | 既存流用 |
| `afterValence` | After からだ (-1〜+1) | 既存流用 |
| `afterArousal` | After こころ (-1〜+1) | 既存流用 |
| `meditationType` | ガイドモード or メニューID | `timer` / `ambient` / `{menuId}` |
| `duration` | 実施時間（秒） | 60 / 300 / 600 等 |
| `memo` | ユーザーメモ | 新規（バックエンド対応待ち） |

---

## 画面別仕様

### 1. 設定画面（settings.tsx）

**追加UI：ガイドモード選択**

```
┌────────────────────────────────────────┐
│ 瞑想ガイド                             │
├────────────────────────────────────────┤
│ ○ タイマーのみ                         │
│   シンプルなタイマーで自分のペースで    │
│                                        │
│ ○ 環境音                               │
│   心地よい環境音とともに                │
│                                        │
│ ○ 瞑想ガイド                           │
│   音声ガイドに沿って（初心者向け）      │
└────────────────────────────────────────┘
```

### 2. ホーム画面（index.tsx）

**変更：感情円環 → スライダーUI**

```
┌────────────────────────────────────────┐
│                                        │
│     今の状態を教えてね                  │
│                                        │
│  ┌──────────────────────────────────┐  │
│  │  からだ                          │  │
│  │  こわばっている ──●── ゆるんでいる │  │
│  └──────────────────────────────────┘  │
│                                        │
│  ┌──────────────────────────────────┐  │
│  │  こころ                          │  │
│  │  ざわざわ ──────●── しずか       │  │
│  └──────────────────────────────────┘  │
│                                        │
│  ┌──────────────────────────────────┐  │
│  │  気づいたことがあれば...（任意）  │  │
│  └──────────────────────────────────┘  │
│                                        │
│        [りなわん GIF]                  │
│      「準備ができたら始めよう」         │
│                                        │
│       [ トレーニングへ進む ]            │
│                                        │
└────────────────────────────────────────┘
```

### 3. 時間選択画面（新規: time-select.tsx）

**①②の場合**

```
┌────────────────────────────────────────┐
│                                        │
│        時間を選んでね！                 │
│                                        │
│   ┌─────┐  ┌─────┐  ┌─────┐           │
│   │30秒 │  │ 5分 │  │10分 │           │
│   └─────┘  └─────┘  └─────┘           │
│                                        │
│        [りなわん GIF]                  │
│                                        │
└────────────────────────────────────────┘
```

**③の場合（感情円環の後）**

```
┌────────────────────────────────────────┐
│                                        │
│     「呼吸を感じる」                    │
│     時間を選んでね                      │
│                                        │
│   ┌─────┐  ┌─────┐  ┌─────┐           │
│   │30秒 │  │ 1分 │  │ 5分 │           │
│   └─────┘  └─────┘  └─────┘           │
│                                        │
│        [りなわん GIF]                  │
│                                        │
└────────────────────────────────────────┘
```

### 4. 感情円環画面（新規: emotion-select.tsx）※③専用

現行の `index.tsx` の感情円環部分を移植。
スライダーで入力した値を `beforeValence/beforeArousal` として渡す。

### 5. タイマー画面（新規: timer.tsx）※①②用

```
┌────────────────────────────────────────┐
│                                        │
│                                        │
│              04:32                     │
│            残り時間                     │
│                                        │
│        [りなわん breathing GIF]        │
│                                        │
│                                        │
│           [ 終了する ]                  │
│                                        │
└────────────────────────────────────────┘
```

- ①タイマーのみ：無音（開始/終了チャイムのみ）
- ②環境音：BGM再生

### 6. After画面（after.tsx）

**現状維持**（Phase 1で作成済み）
- からだ/こころスライダー
- メモ入力
- 記録ボタン → 完了画面

### 7. 履歴画面（tracking.tsx）

**Before表示の変更**

```
変更前：Before [やや不快] [活性高め]
変更後：Before [からだ: ゆるんでいる] [こころ: しずか]
```

---

## 修正対象ファイル

### 新規作成

| ファイル | 説明 |
|---------|------|
| `app/(app)/time-select.tsx` | 時間選択画面 |
| `app/(app)/timer.tsx` | タイマー画面（①②用） |
| `app/(app)/emotion-select.tsx` | 感情円環画面（③用） |
| `hooks/useGuideMode.ts` | ガイドモード設定フック |

### 修正

| ファイル | 変更内容 |
|---------|----------|
| `app/(app)/(tabs)/settings.tsx` | ガイドモード選択UI追加 |
| `app/(app)/(tabs)/index.tsx` | 感情円環→スライダーUI、遷移先分岐 |
| `app/(app)/(tabs)/tracking.tsx` | Before表示を「からだ/こころ」に変更 |
| `app/(app)/recommendation.tsx` | ③の場合のみ使用、時間選択へ遷移変更 |
| `app/(app)/meditation.tsx` | ③の場合のみ使用 |
| `components/PreferencesProvider.tsx` | guideMode追加 |
| `hooks/usePreferences.ts` | guideMode追加 |

---

## 実装順序

### Phase 1-A: 基盤整備 ✅

1. ✅ `hooks/useGuideMode.ts` 作成（または usePreferences に統合）
2. ✅ `components/PreferencesProvider.tsx` にガイドモード追加
3. ✅ `settings.tsx` にガイドモード選択UI追加

### Phase 1-B: ホーム画面リデザイン ✅

4. ✅ `index.tsx` をスライダーUIに全面変更
5. ✅ SessionLog作成ロジック調整（beforeValence/Arousalをスライダー値で保存）

### Phase 1-C: 新画面作成 ✅

6. ✅ `time-select.tsx` 新規作成（時間選択）
7. ✅ `timer.tsx` 新規作成（①②用タイマー）+ 環境音再生機能

### Phase 1-D: 遷移接続 ✅

8. ✅ ホーム → 時間選択 → タイマー → After の流れを接続
9. ✅ ガイドモード別の分岐処理実装

### Phase 1-E: 履歴画面 ✅

10. ✅ `tracking.tsx` のBefore表示を変更

### Phase 2（後日）

11. `emotion-select.tsx` 作成（③用、現行移植）
12. ③の完全フロー実装
13. 各時間の音声ファイル対応

---

## 時間選択の選択肢

### ①タイマーのみ / ②環境音

| 表示 | 値（秒） |
|-----|---------|
| 30秒 | 30 |
| 5分 | 300 |
| 10分 | 600 |

### ③瞑想ガイド（Phase 2）

| 表示 | 値（秒） | 備考 |
|-----|---------|------|
| 30秒 | 30 | 現行音声 |
| 1分 | 60 | 要音声作成 |
| 5分 | 300 | 要音声作成 |

---

## 音声ファイル

### ①タイマーのみ

- `pon.mp3` - 開始/終了チャイム（既存）

### ②環境音（設定で種類を選択可能）✅ 準備完了

**方式:** 各環境音につき10分超のファイル1つを用意。30秒/5分/10分すべて同じファイルを再生し、終了時にフェードアウト。

| 種類 | ファイル名 | キー | 絵文字 |
|------|-----------|------|--------|
| 小鳥 | `birds.mp3` | birds | 🐦 |
| 川 | `river.mp3` | river | 🏞️ |
| 雨 | `rain.mp3` | rain | 🌧️ |
| 波 | `ocean_waves.mp3` | wave | 🌊 |
| 焚き火 | `fire_crackling.mp3` | bonfire | 🔥 |
| シンギングボール | `singing_bowls.mp3` | singing_bowls | 🔔 |

**保存先:** `assets/sounds/`

**フェードアウト実装:**
```typescript
const FADE_DURATION = 3; // 3秒かけてフェードアウト

// タイマー終了3秒前からフェード開始
if (remainingSeconds <= FADE_DURATION) {
  const volume = remainingSeconds / FADE_DURATION;
  sound.setVolumeAsync(volume);
}
```

### ③瞑想ガイド（Phase 2）

**「呼吸を開放する」のみ準備完了:**

| 時間 | ファイル名 | 状態 |
|------|-----------|------|
| 30秒 | `release_breath_30s_rina.m4a` | ✅ 既存 |
| 1分 | `release_breath_1m_rina.m4a` | ✅ 新規 |
| 5分 | `release_breath_5m_rina.m4a` | ✅ 新規 |
| 10分 | `release_breath_10m_rina.m4a` | ✅ 新規 |

**残り11種類:** 後ほど準備予定

---

## 確定事項

- [x] タイマー画面のりなわん: `breathing` GIF（後日、複数GIF組み合わせに拡張予定）
- [x] 時間選択ボタン: **カード型**（タップしやすく視認性が高い）
- [x] 環境音: **6種類から選択可能**（小鳥/川/雨/波/焚き火/シンギングボール）
- [x] 環境音ファイル方式: **10分超ファイル1つ + フェードアウト**
- [x] タイマー終了時: **振動 + 通知あり**
- [x] 時間選択: **30秒/5分/10分**

### TODO（実装完了後）
- [ ] りなわんGIF複数組み合わせ表示について相談
- [x] 環境音ファイル6種類のアップロード ✅
- [x] 瞑想ガイド音声（呼吸を開放する 1分/5分/10分）アップロード ✅
- [ ] 残り11種類の瞑想ガイド音声を準備

---

## 検証方法

1. 各ガイドモードで一連のフローが完走できること
2. SessionLogに正しい値が保存されること
3. 履歴画面で新旧データが正しく表示されること
4. TypeScriptエラーなし（`npx tsc --noEmit`）
